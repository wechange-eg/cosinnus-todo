{% extends "cosinnus_todo/base.html" %}
{% load i18n humanize todo_tags cosinnus_tags thumbnail %}
{% load static from staticfiles %}


{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/vendor/select2.css' %}">
    <link rel="stylesheet" href="{% static 'css/cosinnus_todo/cosinnus_todo.css' %}">
{% endblock extrahead %}


{% block page_title %}
    {% if active_todolist %}{{ active_todolist.title }} - {% endif %}{% trans "TodoEntries" %} {{ block.super }}
{% endblock page_title %}

{% block breadcrumb %}
    {{ block.super }}
    {% if active_todolist %}
        <li><a href="{% group_url 'cosinnus:todo:list' group=group.slug %}">{% trans "Todos" %}</a></li>
        <li class="active">{{ active_todolist.title }}</li>
    {% else %}
        <li class="active">{% trans "Todos" %}</li>
    {% endif %}
{% endblock %}


{% block leftnav %}
    
    {% for todolist in todolists %}
        {% captureas href %}{{ todolist.get_absolute_url }}{% add_current_params %}{% endcaptureas %}
	    {% captureas label %}{{ todolist.title }}{% endcaptureas %}
	    {% captureas button_class %}{% if forloop.last %}regular-space{% else %}fine-space{% endif %}{% endcaptureas %}
	    {% captureas folder_size %}{{ todolist.filtered_item_count }}{% endcaptureas %}
	    {% captureas active %}{% if todolist == active_todolist %}True{% endif %}{% endcaptureas %}
	    {% captureas button_template %}{% if user|can_create_objects_in:todolist.group %}cosinnus/leftnav_button_editable_folder.html{% else %}cosinnus/leftnav_button.html{% endif %}{% endcaptureas %}
	    
	    {% include button_template with active=active extra_classes=button_class icon_content=folder_size label=label href=href folder=todolist %}
    {% empty %}
       <!-- {% trans "There are no todolists yet." %} -->
       {% include 'cosinnus/common/empty_button.html' with message="There are no todolists yet." %}
    {% endfor %}
    
    {% if user|can_create_objects_in:group %}
        <form action="{% group_url 'cosinnus:todo:todolist-add' group=group.slug %}" method="POST" class="form-horizontal">
            {% csrf_token %}
            <div type="button" class="btn btn-default w100">
                <ul class="media-list">
                    <li class="media">
                        <a class="pull-left" href="#">
                            <i class="fa fa-plus"></i>
                        </a>
                        <div class="media-body media-body-form-control">
                            <input name="title" class="form-control next-button-is-for-sending"
                                placeholder="{% trans 'New List Name' %}" value="" />
                        </div>
                    </li>
                </ul>
            </div>
        
            <button type="submit" name="create_todolist" class="btn btn-emphasized large-space" style="display: none;">
                <ul class="media-list">
                    <li class="media">
                        <a class="pull-left" href="#">
                            <i class="fa fa-pencil"></i>
                        </a>
                        <div class="media-body">
                            {% trans "Create" %}
                        </div>
                    </li>
                </ul>
            </button>
        </form>
    {% endif %}
    
{% endblock leftnav %}

{% block content %}
        
<div class="row">
    <div class="col-xs-12">
        <!-- a box with semi transparent background -->
        <div class="content-box">
        
            {% include 'cosinnus/common/filter_controls.html' %}  
        
            {% for todo in todos.all %}
                
                <div class="btn btn{% if todo == active_todo %}-extra{% endif %}-emphasized w100 regular-space">
                    <ul class="media-list">
                        <li class="media">
                            <a class="pull-left" href="#" {% if not user|has_write_access:todo %}disabled="disabled"{% endif %}>
                                <i class="fa fa-{% if todo.is_completed %}check-{% endif %}square-o"></i>
                                {% captureas post_url %}/api/v1/{% cosinnus_group_url_path todo.group %}/{{todo.group.slug}}/todo/todos/{{todo.pk}}/toggle_complete/me/{% endcaptureas %}
                                <input type="hidden" value="{% if todo.is_completed %}true{% else %}false{% endif %}" {% if user|has_write_access:todo %}{% djajax_connect todo.is_completed trigger_on="value_changed" post_to=post_url %}{% endif %} />
                            </a>
                            <a class="pull-left select2-avatar" title="{{ todo.assigned_to|full_name }}">
                                <select {% if not user|has_write_access:todo %}disabled="disabled"{% endif %} class="select2-avatar-item" {% if user|has_write_access:todo %}{% djajax_connect todo.assigned_to %}{% endif %}>
                                    <option value="-1" data-avatar-url="{% static 'images/fragezeichen.png' %}" title="ss">{% trans "Not assigned" %}</option>
                                    
                                    {% for user in group_users %}
                                        <option {% if todo.assigned_to and todo.assigned_to == user %}selected {% endif %} value="{{ user.pk }}" data-avatar-url="{% if user.cosinnus_profile.avatar %}{% thumbnail user.cosinnus_profile.avatar 40x40 crop=1 upscale=1 %}{% else %}{% static 'images/jane-doe.png' %}{% endif %}">
                                            {{ user|full_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </a>
                            <a class="pull-right" href="#">
                                <input class="permanent-visible priority-selector" value="{{ todo.priority }}" {% if user|has_write_access:todo %}{% djajax_connect todo.priority %}{% endif %}/>
                            </a>
                            <div class="media-body">
                                {% captureas todo_date_id %}todoDate{{ todo.pk }}{% endcaptureas %}
                                <a href="#" {% if user|has_write_access:todo %}id="dateSelect{{ todo.pk }}" data-dateelement="#{{ todo_date_id }}" data-toggle="modal" data-target="#datePickerModal"{% endif %}> 
                                    <span class="annotation moment-data-date" {% if user|has_write_access:todo %}{% djajax_connect todo.due_date value_selector="attr" value_selector_arg="data-date" %}{% endif %} data-date="{% if todo.due_date %}{{ todo.due_date|date:"Y-m-d" }}{% endif %}" id="{{ todo_date_id }}" >{% if not todo.due_date %}{% if user|has_write_access:todo %}{% trans "Choose due date" %}{% else %}{% trans "No due date chosen" %}{% endif %}{% endif %}</span>
                                </a>
                                {% with creator=todo.creator %}
                                    <span class="annotation">{% trans "by" %} <a href="{{ creator|profile_url }}" >{{ creator|full_name }}</a>&nbsp;&nbsp;</span>
                                {% endwith %}
                                <span type="text" {% if user|has_write_access:todo %}contenteditable="true" {% djajax_connect todo.title trigger_on="lose_focus,enter_key" value_selector="text" empty="false" %}{% endif %}>{{ todo.title }}</span>
                            </div>
                        </li>
                    </ul>
                </div>
            {% empty %}
                {% if todolists.count > 0 %}
                    <!-- {% trans "There are no todos in this list." %} -->
                    {% include 'cosinnus/common/empty_button.html' with message="There are no todos in this list." %}
                {% else %}
                    <!-- {% trans "Please select or create a todo list." %} -->
                    {% include 'cosinnus/common/empty_button.html' with message="Please select or create a todo list." %}
                {% endif %}
            {% endfor %}
            
            {% if active_todolist and user|can_create_objects_in:group %}
                <form id="create_todo_form" action="{% group_url 'cosinnus:todo:entry-add' group=group.slug %}" method="POST" class="form-horizontal" onSubmit="return createTodoSubmit();">
                    {% csrf_token %}
            
                    <div type="submit" class="btn btn-default w100">
                        <ul class="media-list">
                            <li class="media">
                                <a class="pull-left" href="#"></a>
                                <a class="pull-left" href="#">
                                    <i class="fa fa-pencil"></i>
                                </a>
                                <a class="pull-right" id="datasel1" data-dateelement="#newTaskDate" href="#" data-toggle="modal" data-target="#datePickerModal">
                                    <i class="fa fa-calendar"></i>
                                </a>
                                <div class="media-body media-body-form-control">
                                    <span class="annotation moment-data-date" data-toggle="modal" data-target="#datePickerModal" data-date="today" id="newTaskDate" onchange="$('#due_date_input').attr('value', $('#newTaskDate').attr('data-date'));"></span>
                                    <input id="due_date_input" type="hidden" name="due_date" value="" />
                                    <input type="hidden" name="todolist" value="{{ active_todolist.pk }}" />
                                    <input id="new_todo_input" name="title" class="form-control next-button-is-for-sending"
                                        placeholder="{% trans 'Create a new Todo' %}"
                                        value="" />
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    
                    <button type="submit" id="create_todo_button" name="create_todo" class="btn btn-emphasized" style="display:none;">
                        <ul class="media-list">
                            <li class="media">
                                <a class="pull-left" href="#">
                                    <i class="fa fa-pencil"></i>
                                </a>
                                <div class="media-body">
                                    {% trans "Create" %}
                                </div>
                            </li>
                        </ul>
                    </button>
                </form>
            {% endif %}
            
            
            <!-- Pick Date Modal -->
            <div class="modal fade" id="datePickerModal" tabindex="1" role="dialog" aria-labelledby="datePickerLabel" aria-hidden="true">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <i class="fa fa-times"></i>
                            </button>
                            <h4 class="modal-title" id="datePickerLabel">
                                <i class="fa fa-calendar"></i>
                                {% trans "Choose day" %}
                            </h4>
                        </div>
                        <div class="modal-body">
                            <p>{% trans "Until when should the task be completed?" %}</p>
                            <div class="small-calendar" data-dateelement=""></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="datePickerModal_submit" class="btn btn-emphasized"  data-dismiss="modal">
                                <ul class="media-list">
                                    <li class="media">
                                        <a class="pull-left" href="#">
                                            <i class="fa fa-check"></i>
                                        </a>
                                        <div class="media-body">
                                            {% trans "OK" %}
                                        </div>
                                    </li>
                                </ul>
                            </button>
                        </div>
                    </div>
                </div>
            </div><!-- modal -->
            
            
        </div><!-- content-box -->
    </div><!-- col -->
</div><!-- row -->
                        

{% endblock content %}


{% block extrafooter %}
{{ block.super }}

<script type="text/javascript">
    var select2Format = function(state) {
        var $originalOption = $(state.element);
    
        if (!state.id) {
            return state.text;
        } else {
            var avatarUrl = $originalOption.data('avatar-url');
            return "<img class='avatar-img' src='"+window.location.origin+avatarUrl+"'/>" + state.text;
        }
    };
    
    var select2Options = {
        formatResult: select2Format,
        formatSelection: select2Format,
        escapeMarkup: function(m) { return m; }
    };
    
    var createTodoSubmit = function(e) {
        if ($('#new_todo_input').val().length <= 0) {
            alert('{% trans "Please enter a title for the task!" %}');
            return false;
        }
        return true;
    };
    
    $(".select2-avatar-item").select2(select2Options);
    
    $("#new_todo_input").focus();
</script>


{% endblock extrafooter %}
