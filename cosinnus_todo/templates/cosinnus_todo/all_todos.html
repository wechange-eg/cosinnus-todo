{% extends "cosinnus_todo/base.html" %}
{% load i18n humanize todo_tags cosinnus_tags thumbnail %}
{% load static from staticfiles %}


{% block extrahead %}
	{{ block.super }}
	<link rel="stylesheet" href="{% static 'css/vendor/select2.css' %}">
	{% comment %} TODO: CLEANUP CSS {% endcomment %}
	<link rel="stylesheet" href="{% static 'css/cosinnus_todo.css' %}">
	
    <script src="{% static 'js/djajax.js' %}"></script>
{% endblock extrahead %}


{% block page_title %}
    {% trans "TodoEntries" %} {{ block.super }}
{% endblock page_title %}

{% block breadcrumb %}
    {{ block.super }}
    <li class="active">{% trans "Todos" %}</li>
{% endblock %}

{% block leftnav %}
	
	{% for todolist in todolists %}
	
	    <button type="button" href="{{ todolist.get_absolute_url }}" class="btn w100 btn-emphasized {% if forloop.last %}regular-space{% else %}fine-space{% endif %}">
	        <ul class="media-list">
	            <li class="media">
	                <a class="pull-left" href="#">
	                    {{ todolist.todos.count }}
	                </a>
	                <a class="pull-right" href="#">
	                    {% if todolist == active_todolist %}<i class="fa fa-caret-right"></i>{% endif %}
	                </a><!-- only block width -->
	                <div class="media-body">
	                    {{ todolist.title }}
	                </div>
	            </li>
	        </ul>
	    </button>
    
    {% endfor %}

    <div type="button" class="btn btn-default w100">
        <ul class="media-list">
            <li class="media">
                <a class="pull-left" href="#">
                    <i class="fa fa-plus"></i>
                </a>
                <div class="media-body">
                    <input class="form-control next-button-is-for-sending"
                        placeholder="Neuer Listenname         " value="" />
                </div>
            </li>
        </ul>
    </div>

    <button type="button" class="btn btn-emphasized large-space" style="display: none;">
        <ul class="media-list">
            <li class="media">
                <a class="pull-left" href="#">
                    <i class="fa fa-pencil"></i>
                </a>
                <div class="media-body">
                    Erstellen
                </div>
            </li>
        </ul>
    </button>
	
{% endblock leftnav %}

{% block content %}
	    
<div class="row">
    <div class="col-xs-12">
        <!-- a box with semi transparent background -->
        <div class="content-box">
        
			{% for todo in todos.all %}
			    
			    <div class="btn btn{% if todo == active_todo %}-extra{% endif %}-emphasized w100 regular-space">
			        <ul class="media-list">
			            <li class="media">
			                <a class="pull-left" href="#">
			                    <i class="fa fa-{% if todo.is_completed %}check-{% endif %}square-o"></i>
			                    {% captureas post_url %}/api/v1/group/{{todo.group.slug}}/todo/todos/{{todo.pk}}/toggle_complete/me/{% endcaptureas %}
			                    <input type="hidden" value="{% if todo.is_completed %}true{% else %}false{% endif %}" {% djajax_connect todo.is_completed trigger_on="value_changed" post_to=post_url %} />
			                </a>
			                <a class="pull-left select2-avatar" title="{{ todo.assigned_to|full_name }}">
			                    <select class="select2-avatar-item" {% djajax_connect todo.assigned_to %}>
			                        <option value="-1" data-avatar-url="{% static 'images/fragezeichen.png' %}"> keine Zuweisung</option>
			                        
			                        {% for user in group_users %}
			                            <option {% if todo.assigned_to and todo.assigned_to == user %}selected {% endif %} value="{{ user.pk }}" data-avatar-url="{% if user.cosinnus_profile.avatar %}{% thumbnail user.cosinnus_profile.avatar 40x40 crop=1 upscale=1 %}{% else %}{% static 'images/jane-doe.png' %}{% endif %}">
			                                {{ user|full_name }}
			                            </option>
			                        {% endfor %}
			                    </select>
			                </a>
			                
			                <select class="pull-right permanent-visible" href="#" {% djajax_connect todo.priority value_object_property="selectedIndex" value_transform="priorityIndexToPriority" %}>
			                        <option {% if todo.priority == 3 %}selected="selected"{% endif %}> &nbsp;  Wichtig</option>
			                        <option {% if not todo.priority or todo.priority == 2 %}selected="selected"{% endif %}>&nbsp; &nbsp;  Normal</option>
			                        <option {% if todo.priority == 1 %}selected="selected"{% endif %}>  &nbsp; Später</option>
			                </select>
			                <div class="media-body">
			                    {% captureas todo_date_id %}todoDate{{ todo.pk }}{% endcaptureas %}
			                    <a id="dateSelect{{ todo.pk }}" data-dateelement="#{{ todo_date_id }}" href="#" data-toggle="modal" data-target="#datePickerModal"> 
			                        <span class="annotation moment-data-date" id='{{ todo_date_id }}' {% djajax_connect todo.due_date value_selector="attr" value_selector_arg="data-date" %} data-date="{% if todo.due_date %}{{ todo.due_date|date:"Y-m-d" }}{% endif %}" id="{{ todo_date_id }}" >{% if not todo.due_date %}{% if user|has_write_access:todo %}{% trans "Fälligkeitsdatum wählen" %}{% else %}{% trans "Kein Fälligkeitsdatum gewählt" %}{% endif %}{% endif %}</span>
			                    </a>
			                    <span type="text" contenteditable="true" {% djajax_connect todo.title trigger_on="lose_focus,enter_key" value_selector="text" %}>{{ todo.title }}</span>
			                </div>
			            </li>
			        </ul>
			    </div>
			
			
			{% endfor %}
			
			
            <div type="button" class="btn btn-default w100">
                <ul class="media-list">
                    <li class="media">
                        <a class="pull-left" href="#"></a>
                        <a class="pull-left" href="#">
                            <i class="fa fa-pencil"></i>
                        </a>
                        <a class="pull-right" id="datasel1" data-dateelement="#newTaskDate" href="#" data-toggle="modal" data-target="#datePickerModal">
                            <i class="fa fa-calendar"></i>
                        </a>
                        <div class="media-body">
                            <span class="annotation moment-data-date" data-toggle="modal" data-target="#datePickerModal" data-date="today" id="newTaskDate"></span>
                            <input id="new_todo_input" class="form-control next-button-is-for-sending"
                                placeholder="Lege eine neue Aufgabe an."
                                value="" />
                        </div>
                    </li>
                </ul>
            </div>
            
            
            <button type="button" class="btn btn-emphasized" style="display:none;">
                <ul class="media-list">
                    <li class="media">
                        <a class="pull-left" href="#">
                            <i class="fa fa-pencil"></i>
                        </a>
                        <div class="media-body">
                            Erstellen
                        </div>
                    </li>
                </ul>
            </button>
            
            
            
            
            <!-- Pick Date Modal -->
            <div class="modal fade" id="datePickerModal" tabindex="1" role="dialog" aria-labelledby="datePickerLabel" aria-hidden="true">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                <i class="fa fa-times"></i>
                            </button>
                            <h4 class="modal-title" id="datePickerLabel">
                                <i class="fa fa-calendar"></i>
                                Tag auswählen
                            </h4>
                        </div>
                        <div class="modal-body">
                            <p>Bis wann soll die Aufgabe erledigt sein?</p>
                            <div class="small-calendar" data-dateelement=""></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="datePickerModal_submit" class="btn btn-emphasized"  data-dismiss="modal">
                                <ul class="media-list">
                                    <li class="media">
                                        <a class="pull-left" href="#">
                                            <i class="fa fa-check"></i>
                                        </a>
                                        <div class="media-body">
                                            OK
                                        </div>
                                    </li>
                                </ul>
                            </button>
                        </div>
                    </div>
                </div>
            </div><!-- modal -->
			
			
        </div><!-- content-box -->
    </div><!-- col -->
</div><!-- row -->
                        

{% endblock content %}


{% block extrafooter %}
{{ block.super }}

{% djajax generate %}

<script src="{% static 'js/vendor/json2.js' %}"></script>
<script src="{% static 'js/vendor/select2.min.js' %}"></script>
<script src="{% static 'js/vendor/moment.js' %}"></script>
<script src="{% static 'js/vendor/locales/moment.de.js' %}"></script>

<script src="{% static 'js/cosinnus/utils.js' %}"></script>

<script type="text/javascript">
    var priorityIndexToPriority = function(v) {
        if (v == '0') return 3;
        if (v == '1') return 2;
        if (v == '2') return 1;
    };
    
    
	var select2Format = function(state) {
	    var $originalOption = $(state.element);
	
	    if (!state.id) {
	        return state.text;
	    } else {
	        var avatarUrl = $originalOption.data('avatar-url');
	        return "<img class='flag avatar-img' src='"+window.location.origin+avatarUrl+"'/>" + state.text;
	    }
	};
	
	var select2Options = {
	    formatResult: select2Format,
	    formatSelection: select2Format,
	    escapeMarkup: function(m) { return m; }
	};
    
    
    $(".select2-avatar-item").select2(select2Options);
    
    $("#new_todo_input").focus();
</script>


{% endblock extrafooter %}
